name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: Install Dioxus CLI (0.7.0 Binary)
      run: |
        # Exact URL from the 0.7.0 release assets
        wget https://github.com/DioxusLabs/dioxus/releases/download/v0.6.3/dx-x86_64-unknown-linux-gnu-v0.7.0.tar.gz
        tar -xzf dx-x86_64-unknown-linux-gnu-v0.6.3.tar.gz
        chmod +x dx
        sudo mv dx /usr/local/bin/
        dx --version

    - name: Build Dioxus App
      working-directory: ./smg-portfolio 
      run: |
        dx build --release --platform web
        
        mkdir -p dist
        cp -r target/dx/smg-portfolio/release/web/public/* dist/

        # 1. Fix the JS/WASM paths (which you already have working)
        sed -i 's|assets/|/portfolio/assets/|g' dist/index.html
        sed -i 's|/./assets/|/portfolio/assets/|g' dist/index.html

        # 2. Fix the Hardcoded CSS line
        # We find the actual hashed filename in the assets folder
        REAL_CSS=$(ls dist/assets/main-*.css | head -n 1 | xargs basename)
        
        # We replace the broken "main.css" with the correct full path
        sed -i "s|href=\"main.css\"|href=\"/portfolio/assets/$REAL_CSS\"|g" dist/index.html

        # 3. Double Check
        echo "Verifying CSS path in index.html:"
        grep "stylesheet" dist/index.html
          
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        # This path points exactly to where we forced the output
        folder: smg-portfolio/dist 
        branch: gh-pages